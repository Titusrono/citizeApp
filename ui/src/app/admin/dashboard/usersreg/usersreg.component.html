<div class="w-full">
  <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-4 text-purple-700">ðŸ‘¥ Registered Users</h2>

  <!-- SubCounty Filter -->
  <div class="mb-4 max-w-xs">
    <label class="block text-sm font-medium text-gray-700 mb-1">Filter by SubCounty:</label>
    <select [(ngModel)]="selectedSubCounty" (change)="applySubCountyFilter()" class="border px-3 py-2 rounded w-full text-sm">
      <option value="">All SubCounties</option>
      <option *ngFor="let sub of subCounties" [value]="sub">{{ sub }}</option>
    </select>
  </div>

  <!--  SubCounty Stats (Condensed) -->
  <div class="mb-6">
    <h3 class="font-semibold text-gray-700 mb-2"> User Distribution by SubCounty</h3>
    <div class="flex flex-wrap gap-2 text-sm text-gray-800">
      <div
        *ngFor="let stat of subCountyStats"
        class="w-[140px] bg-white border rounded-md p-2 shadow-sm text-center"
      >
        <p class="font-semibold text-purple-700 text-sm truncate">{{ stat.subCounty }}</p>
        <p class="text-gray-600 text-xs">{{ stat.count }} users</p>
        <p class="text-green-600 font-semibold text-sm">{{ stat.percentage }}%</p>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="text-center text-gray-500 text-sm">Loading users...</div>
  <div *ngIf="errorMessage" class="text-red-600 text-sm">{{ errorMessage }}</div>

  <!-- Responsive scroll container -->
  <div class="overflow-x-auto rounded border border-gray-200">
    <table *ngIf="!loading && users.length > 0" class="min-w-full bg-white text-xs sm:text-sm">
      <thead class="bg-gray-100 text-left text-gray-600 uppercase font-semibold">
        <tr>
          <th class="py-2 px-2 sm:px-4 border-b">No.</th>
          <th class="py-2 px-2 sm:px-4 border-b">Username</th>
          <th class="py-2 px-2 sm:px-4 border-b">Email</th>
          <th class="py-2 px-2 sm:px-4 border-b">Phone</th>
          <th class="py-2 px-2 sm:px-4 border-b">SubCounty</th>
          <th class="py-2 px-2 sm:px-4 border-b">Ward</th>
          <th class="py-2 px-2 sm:px-4 border-b">Role</th>
          <th class="py-2 px-2 sm:px-4 border-b">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users; let i = index" class="hover:bg-gray-50">
          <td class="py-2 px-2 sm:px-4 border-b">{{ i + 1 }}</td>

          <!-- Username -->
          <td class="py-2 px-2 sm:px-4 border-b">
            <span *ngIf="editUser?.email !== user.email">{{ user.username }}</span>
            <input
              *ngIf="editUser?.email === user.email"
              type="text"
              [(ngModel)]="editUser.username"
              class="border p-1 rounded w-full text-xs"
            />
          </td>

          <!-- Email -->
          <td class="py-2 px-2 sm:px-4 border-b">{{ user.email }}</td>

          <!-- Phone -->
          <td class="py-2 px-2 sm:px-4 border-b">
            <span *ngIf="editUser?.email !== user.email">{{ user.phone_no }}</span>
            <input
              *ngIf="editUser?.email === user.email"
              type="text"
              [(ngModel)]="editUser.phone_no"
              class="border p-1 rounded w-full text-xs"
            />
          </td>

          <!-- SubCounty -->
          <td class="py-2 px-2 sm:px-4 border-b">
            <span *ngIf="editUser?.email !== user.email">{{ user.subCounty }}</span>
            <input
              *ngIf="editUser?.email === user.email"
              type="text"
              [(ngModel)]="editUser.subCounty"
              class="border p-1 rounded w-full text-xs"
            />
          </td>

          <!-- Ward -->
          <td class="py-2 px-2 sm:px-4 border-b">
            <span *ngIf="editUser?.email !== user.email">{{ user.ward }}</span>
            <input
              *ngIf="editUser?.email === user.email"
              type="text"
              [(ngModel)]="editUser.ward"
              class="border p-1 rounded w-full text-xs"
            />
          </td>

          <!-- Role -->
          <td class="py-2 px-2 sm:px-4 border-b capitalize">
            <span *ngIf="editUser?.email !== user.email">{{ formatRole(user.role) }}</span>
            <select
              *ngIf="editUser?.email === user.email"
              [(ngModel)]="editUser.role"
              class="border p-1 rounded w-full text-xs"
            >
              <option value="citizen">Citizen</option>
              <option value="ward_manager">Ward Manager</option>
              <option value="constituency_manager">Constituency Manager</option>
              <option value="admin">Admin</option>
              <option value="super_admin">Super Admin</option>
            </select>
          </td>

          <!-- Actions -->
          <td class="py-2 px-2 sm:px-4 border-b space-x-1 whitespace-nowrap">
            <div *ngIf="editUser?.email !== user.email">
              <button
                (click)="startEdit(user)"
                class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 text-xs"
              >
                Edit
              </button>
              <button
                (click)="deleteUser(user.email)"
                class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs"
              >
                Delete
              </button>
            </div>

            <div *ngIf="editUser?.email === user.email">
              <button
                (click)="saveEdit()"
                class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 text-xs"
              >
                Save
              </button>
              <button
                (click)="cancelEdit()"
                class="bg-gray-400 text-white px-2 py-1 rounded hover:bg-gray-500 text-xs"
              >
                Cancel
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!loading && users.length === 0" class="text-gray-500 text-sm mt-3">No users found.</div>
</div>
